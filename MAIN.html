<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radiopharmaceuticals ðŸ§ </title>
    <link rel="stylesheet" href="/HTML/style.css">

    <!-- D3 library -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <style>
        body {
            background-color: rgb(17, 29, 44);
            font-family: Verdana, Geneva, Tahoma, sans-serif;
            margin: 0;
            padding: 0;
        }

        .content-wrapper {
            max-width: 800px;
            margin: 10px;
            padding: 10px;
        }

        .sidebar ul {
            list-style: none;
            padding: 10px;
            margin: 0;
        }

        .sidebar li {
            margin: 10px 0;
        }

        .sidebar a {
            color: rgb(0, 255, 153);
            text-decoration: none;
            font-size: 20px;
        }

        .layout {
            display: flex;
            align-items: flex-start;
        }

        .sidebar {
            width: 170px;
            position: sticky;
            top: 40px;
            padding-right: 0;
        }

        .content-wrapper {
            max-width: 800px;
            margin-left: 100px;
            margin-right: 50px;
        }
    </style>
</head>

<body>
<div class="layout">
    <!-- LEFT SIDEBAR -->
    <nav class="sidebar">
        <ul>
            <li><a href="MAIN.html">Home</a></li>
            <li><a href="HTML/about.html">Author</a></li>
            <li><a href="HTML/Dishes.html">Dishes</a></li>
            <li><a href="https://www.guadalupetx.gov/page/open/1868/0/2025_ElectedOfficials_Fed.pdf">Contact</a></li>
        </ul>
    </nav>

    <div class="content-wrapper">

        <h1 style="font-family: Georgia, 'Times New Roman', serif; font-size: 40px; color: rgb(31, 234, 109); text-align: center;">
            Radiopharmaceutical Use Visualiser
        </h1>

        <h1 style="color: white; font-size: 20px;">What are radiopharmaceuticals?</h1>

        <hr>

        <a href="https://reasonator.toolforge.org/?q=Q33202843&lang=en"
           target="_blank" style="color:white;">
           an inspiration for this research
        </a>

        <br><br>

        <p style="color: white;">
            <img src="https://pubs.acs.org/cms/10.1021/acscentsci.3c01050/asset/images/large/oc3c01050_0001.jpeg"
                 alt="Radiopharmaceuticals diagram" height="200">
            Radiopharmaceuticals, or medicinal radiocompounds, are a group of pharmaceutical drugs containing radioactive isotopes. Radiopharmaceuticals can be used as diagnostic and therapeutic agents. Radiopharmaceuticals emit radiation themselves, which is different from contrast media which absorb or alter external electromagnetism or ultrasound.
        </p>

        <strong style="color:white;">Summarised desired properties of radiopharmaceuticals:</strong>

        <ul style="color:white;">
            <li>Low binding inhibition constant (Ki)</li>
            <li>Low dissociation constants (Kd &lt; 10 nM)</li>
            <li>Slow but reversible off-rates</li>
            <li>Small molecular weight (&lt; 450 Da)</li>
            <li>Moderately lipophilic (logP 0.9â€“2.5)</li>
            <li>No P-glycoprotein substrate activity</li>
        </ul>

        <hr>
        <div class="box" style="color:white;">Box1</div>

        <h2 style="color:red;">Library tests</h2>

        <script>
            console.log("D3 version:", d3.version);

            d3.select(".content-wrapper")
              .append("p")
              .text("D3 is working!")
              .style("color", "green");
        </script>

        <div class="section" style="color:rgb(42, 217, 68); padding-top: 50px; padding-right: 20px;">
            <h2>SPARQL Explorer</h2>

            <label for="endpoint">Endpoint URL:</label><br>
            <input id="endpoint" type="text" value="https://bio2rdf.org/sparql"><br><br>

            <label for="query">SPARQL Query:</label><br>
            <textarea id="query" rows="8" style="width:100%;">
PREFIX rdfs:    &lt;http://www.w3.org/2000/01/rdf-schema#&gt;
PREFIX dct:     &lt;http://purl.org/dc/terms/&gt;
PREFIX pharmgkb:&lt;http://bio2rdf.org/pharmgkb_vocabulary:&gt;

SELECT DISTINCT
  
  ?drugLabel
  
  ?atcID
WHERE {
  ?drug pharmgkb:x-atc ?atc .
  ?drug rdfs:label ?drugLabel .
  ?atc  dct:identifier ?atcID .

  FILTER (
    STRSTARTS(STR(?atc), "http://bio2rdf.org/atc:V09") ||
    STRSTARTS(STR(?atc), "http://bio2rdf.org/atc:V10")
  )
}
            </textarea><br>

            <button id="run" style="background-color:#04AA6D; color:white; padding:5px 10px; border:none; cursor:pointer;">
                Run Query
            </button>

            <div id="results" style="margin-top:20px; color:white;"></div>

            <h2 style="color:white; margin-top:30px;">Knowledge graph</h2>
            <svg id="graph" width="600" height="400" style="background:#102030;"></svg>
        </div>
    </div>
</div>

<script>
  // ---- Render JSON result as HTML table ----
  function renderResults(data) {
    const bindings = data.results?.bindings;
    if (!bindings || bindings.length === 0) return '<p>No results.</p>';

    const vars = data.head.vars;
    let html = '<table style="border-collapse:collapse; color:white;">';
    html += '<thead><tr>';
    vars.forEach(v => html += `<th style="border:1px solid #555; padding:4px;">${v}</th>`);
    html += '</tr></thead><tbody>';

    bindings.forEach(row => {
      html += '<tr>';
      vars.forEach(v => {
        const cell = row[v];
        const value = cell ? cell.value : '';
        html += `<td style="border:1px solid #555; padding:4px;">${escapeHtml(value)}</td>`;
      });
      html += '</tr>';
    });
    html += '</tbody></table>';
    return html;
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // ---- Main runner (GET â€“ works for most public endpoints) ----
  async function runSparql() {
    const endpoint = document.getElementById('endpoint').value.trim();
    const query    = document.getElementById('query').value.trim();
    const resultsDiv = document.getElementById('results');

    if (!endpoint || !query) {
      resultsDiv.innerHTML = '<p style="color:red;">Endpoint and query required.</p>';
      return;
    }

    resultsDiv.innerHTML = '<p>Loadingâ€¦</p>';

    const url = new URL(endpoint);
    url.searchParams.append('query', query);
    url.searchParams.append('format', 'json');

    try {
      const response = await fetch(url, {
        method: 'GET',
        headers: {
          'Accept': 'application/sparql-results+json'
        }
      });

      if (!response.ok) throw new Error(`HTTP ${response.status}`);

      const data = await response.json();
      resultsDiv.innerHTML = renderResults(data);

      // Draw graph:
      drawGraphFromSparql(data);

    } catch (err) {
      resultsDiv.innerHTML = `<p style="color:red;">Error: ${escapeHtml(err.message)}</p>`;
    }
  }




  // ---- Build nodes + links from SPARQL result ----
  function buildGraphFromSparql(data) {
    const bindings = data.results?.bindings || [];

    const nodeMap = new Map();
    const links = [];

    function addNode(id, label, type) {
      if (!nodeMap.has(id)) {
        nodeMap.set(id, { id, label, type });
      }
      return nodeMap.get(id);
    }

    bindings.forEach(row => {
      const drugURI   = row.drug?.value;
      const drugLabel = row.drugLabel?.value || drugURI;
      const atcURI    = row.atc?.value;
      const atcID     = row.atcID?.value || atcURI;

      if (!drugURI || !atcURI) return;

      const drugNode = addNode(drugURI, drugLabel, "drug");
      const atcNode  = addNode(atcURI,  atcID,     "atc");

      links.push({
        source: drugNode.id,
        target: atcNode.id
      });
    });

    return {
      nodes: Array.from(nodeMap.values()),
      links: links
    };
  }

  // ---- Draw force-directed graph with D3 ----
  function drawGraphFromSparql(data) {
    const graph = buildGraphFromSparql(data);

    const svg = d3.select("#graph");
    svg.selectAll("*").remove(); // clear old graph

    const width = +svg.attr("width");
    const height = +svg.attr("height");

    const color = d3.scaleOrdinal()
      .domain(["drug", "atc"])
      .range(["#ffcc00", "#66ccff"]);

    const simulation = d3.forceSimulation(graph.nodes)
      .force("link", d3.forceLink(graph.links)
        .id(d => d.id)
        .distance(80))
      .force("charge", d3.forceManyBody().strength(-150))
      .force("center", d3.forceCenter(width / 2, height / 2));

    const link = svg.append("g")
      .attr("stroke", "#aaa")
      .attr("stroke-width", 1.2)
      .selectAll("line")
      .data(graph.links)
      .enter().append("line");

    const node = svg.append("g")
      .selectAll("circle")
      .data(graph.nodes)
      .enter().append("circle")
        .attr("r", 8)
        .attr("fill", d => color(d.type))
        .call(
          d3.drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended)
        );

    const label = svg.append("g")
      .selectAll("text")
      .data(graph.nodes)
      .enter().append("text")
        .attr("font-size", 10)
        .attr("fill", "white")
        .attr("dx", 10)
        .attr("dy", 4)
        .text(d => d.label);

    simulation.on("tick", () => {
      link
        .attr("x1", d => d.source.x)
        .attr("y1", d => d.source.y)
        .attr("x2", d => d.target.x)
        .attr("y2", d => d.target.y);

      node
        .attr("cx", d => d.x)
        .attr("cy", d => d.y);

      label
        .attr("x", d => d.x)
        .attr("y", d => d.y);
    });

    function dragstarted(event, d) {
      if (!event.active) simulation.alphaTarget(0.3).restart();
      d.fx = d.x;
      d.fy = d.y;
    }

    function dragged(event, d) {
      d.fx = event.x;
      d.fy = event.y;
    }

    function dragended(event, d) {
      if (!event.active) simulation.alphaTarget(0);
      d.fx = null;
      d.fy = null;
    }
  }

  document.getElementById('run').addEventListener('click', runSparql);
</script>

</body>
</html>
